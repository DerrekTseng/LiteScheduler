<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Lite Scheduler</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link th:href="@{/bootstrap@5.0.2/bootstrap.min.css}" rel="stylesheet" />
	<script th:src="@{/bootstrap@5.0.2/bootstrap.bundle.min.js}"></script>
	<link th:href="@{/bootstrap-icons@1.9.0/bootstrap-icons.css}" rel="stylesheet" />
	<link th:href="@{/lite-scheduler-lib.css}" rel="stylesheet" />
	<script th:src="@{/lite-scheduler-lib.js}"></script>
	<script th:inline="javascript">

		DocumentUtils.ready(() => {
			doQuery();
		});

		function doQuery() {
			HttpUtils.doPost({
				url: "qryGridScheduleRows",
				success: renderTable
			});
		}

		function renderTable(data) {
			ElementUtils.renderTable({
				table: document.getElementById("table"),
				data: data,
				thead: [
					{html: "排程代號", style: "width:10%"},
					{html: "排程名稱"},
					{html: "上次完成時間", style: "width:114px"},
					{html: "上次執行結果", style: "width:114px"},
					{html: "下次執行時間", style: "width:114px"},
					{html: "啟/停用", clazz: "text-center", style: "width:100px"},
					{html: "歷程", clazz: "text-center", style: "width:60px"},
					{html: "執行", clazz: "text-center", style: "width:60px"},
					{html: "刪除", clazz: "text-center", style: "width:60px"},
					{html: "明細", clazz: "text-center", style: "width:60px"}
				],
				tbody: [
					{html: "@{id}"},
					{html: "@{name}"},
					{html: "@{lastEndDate:date}"},
					{html: "@{lastExecutedState}"},
					{html: "@{nextStartDate:date}"},
					{html: "<select select-state class='form-select'></select>"},
					{html: ElementUtils.iconButtonHtml("btn-history", "secondary", "book")},
					{html: ElementUtils.iconButtonHtml("btn-run", "success", "play-fill")},
					{html: ElementUtils.iconButtonHtml("btn-delete", "danger", "trash")},
					{html: ElementUtils.iconButtonHtml("btn-detail", "primary", "search")}
				],
				treach: (item, $tr) => {

					let $select = $tr.querySelector("[select-state]");
					
					ElementUtils.selectOptions($select, [
						{text: "啟用", value: "Enabled"},
						{text: "停用", value: "Disabled"}
					], item.state);
					$select.addEventListener("change", () => {
						updateScheduleEnable(item.id, $select.value)
					});

					$tr.querySelector("[btn-history]").addEventListener("click", () => {
						openScheduleHistory(item.id);
					});

					$tr.querySelector("[btn-run]").addEventListener("click", () => {
						runSchedule(item.id);
					});

					$tr.querySelector("[btn-delete]").addEventListener("click", () => {
						deleteSchedule(item.id);
					});

					$tr.querySelector("[btn-detail]").addEventListener("click", () => {
						openScheduleDetail(item.id);
					});

				}
			});
		}

		function updateScheduleEnable(id, state) {
			HttpUtils.doPost({
				url: "updateScheduleEnable",
				data: {id, state},
				success: (data) => {
					if (data.succeeded) {
						PromptUtils.success(data.message);
					} else {
						PromptUtils.error(data.message);
					}
				}
			});
		}

		function openCreateSchedule() {
			DialogUtils.window({
				title: "新增排程",
				url: "openCreateSchedule"
			});
		}

		function openGlobleParameter() {
			DialogUtils.window({
				title: "全域參數",
				url: "openGlobleParameter"
			});
		}

		function openScheduleHistory(id) {
			DialogUtils.window({
				title: "排程歷程",
				data: {id},
				url: "openScheduleHistory"
			});
		}

		function openScheduleDetail(id) {
			DialogUtils.window({
				title: "排程明細",
				data: {id},
				url: "openScheduleDetail"
			});
		}

		function deleteSchedule(id) {
			// TODO	
		}

		function runSchedule(id) {
			// TODO
		}

	</script>
</head>

<body>

	<div class="container-fluid">

		<div class="row">
			<div class="col">
				<button onClick="openCreateSchedule()" type="button" class="btn btn-success m-2">
					<i class="bi bi-plus-lg"></i>
				</button>
				<button onClick="openGlobleParameter()" type="button" class="btn btn-info m-2">
					<i class="bi bi-gear-fill"></i>
				</button>
			</div>

		</div>

		<div class="row">
			<div class="col">
				<table id="table" class="table table-striped table-bordered table-hover">
				</table>
			</div>
		</div>
	</div>


</body>

</html>