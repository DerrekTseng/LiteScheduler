<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<title>Lite Scheduler</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link th:href="@{/bootstrap@5.0.2/bootstrap.min.css}" rel="stylesheet" />
	<script th:src="@{/bootstrap@5.0.2/bootstrap.bundle.min.js}"></script>
	<link th:href="@{/bootstrap-icons@1.9.0/bootstrap-icons.css}" rel="stylesheet" />
	<link th:href="@{/lite-scheduler-lib.css}" rel="stylesheet" />
	<script th:src="@{/lite-scheduler-lib.js}"></script>
	
	<script th:inline="javascript">
	
		const scheduleId = /*[[${id}]]*/ "";
		
		DocumentUtils.ready(() => {
			doQuery();
		});
	
		function doQuery() {
			HttpUtils.doPost({
				url: "qryScheduleDetail",
				data: {id: scheduleId },
				success: (data) => {
					
					myForm.scheduleId.value = data.id;
					myForm.scheduleName.value = data.name;
					myForm.scheduleDescription.value = data.description;
					myForm.cronExp.value = data.cronExp;
					
					renderJobGroups(data.gridJobGroupRows);
					renderScheduleParameters(data.scheduleParameters);
				}
			});
		}
		
		function renderJobGroups(data) {
			ElementUtils.renderTable({
				table: document.getElementById("jobGroups"),
				captions: [{
					side: "top", 
					text: `
						<div class="row">
							<div class="col text-center">
								<span class="fs-4">工作群組列表</span>
							</div>
						</div>
						<div class="row">
							<div class="col">
								${ElementUtils.iconButtonHtml({
									color: "outline-success",
									icon: "plus-lg",
									size: "sm",
									click: "openJobGroupCreate()"
								})}
								${ElementUtils.iconButtonHtml({
									color: "outline-secondary",
									icon: "sort-numeric-down",
									size: "sm",
									click: "openJobGroupSequence()"
								})}
							</div>
						</div>
					`
				}],
				data: data,
				thead: [
					{ html: "順序", clazz: "text-center", style: "width: 100px"},
					{ html: "群組名稱"},
					{ html: "啟/停用", clazz: "text-center", style: "width: 100px"},
					{ html: "執行", clazz: "text-center", style: "width: 60px"},
					{ html: "刪除", clazz: "text-center", style: "width: 60px"},
					{ html: "明細", clazz: "text-center", style: "width: 60px"},
				],
				tbody: [
					{ html: "@{sequence}", clazz: "text-center align-middle" },
					{ html: "@{name}", clazz: "align-middle" },
					{html: "<select select-state class='form-select'></select>"},
					{html: ElementUtils.iconButtonHtml({
						color: "success",
						icon: "play-fill",
						click: "runJobGroup('@{id}', '@{name}')"
					})},
					{html: ElementUtils.iconButtonHtml({
						color: "danger",
						icon: "trash",
						click: "deleteJobGroup('@{id}', '@{name}')"
					})},
					{html: ElementUtils.iconButtonHtml({
						color: "primary",
						icon: "search",
						click: "openJobGroupDetail('@{id}')"
					})}
				],
				treach: (item, $tr) => {
					let $select = $tr.querySelector("[select-state]");
	
					ElementUtils.selectOptions($select, [
						{text: "啟用", value: "Enabled"},
						{text: "停用", value: "Disabled"}
					], item.state);
					$select.addEventListener("change", () => {
						updateJobGroupEnable(item.id, $select.value)
					});
					
				}
			});
		}
		
		function renderScheduleParameters(data) {
			ElementUtils.renderTable({
				table: document.getElementById("scheduleParameters"),
				captions: [{
					side: "top", 
					text: `
						<div class="row">
							<div class="col text-center">
								<span class="fs-4">排程參數</span>
							</div>
						</div>
						<div class="row">
							<div class="col">
								${ElementUtils.iconButtonHtml({
									color: "outline-success",
									icon: "plus-lg",
									size: "sm",
									click: "openScheduleParametersCreate()"
								})}
							</div>
						</div>
					`
				}],
				data: data,
				thead: [
					{ html: "參數名稱"},
					{ html: "參數數值"},
					{ html: "啟/停用", clazz: "text-center", style: "width: 100px"},
					{ html: "刪除", clazz: "text-center", style: "width: 60px"},
					{ html: "編輯", clazz: "text-center", style: "width: 60px"},
				],
				tbody: [
					{ html: "@{name}", clazz: "align-middle" },
					{ html: "@{value}", clazz: "align-middle" },
					{html: "<select select-enable class='form-select'></select>"},
					{html: ElementUtils.iconButtonHtml({
						color: "success",
						icon: "play-fill",
						click: "deleteScheduleParameter('@{id}', '@{name}')"
					})},
					{html: ElementUtils.iconButtonHtml({
						color: "danger",
						icon: "trash",
						click: "openEditScheduleParameter('@{id}', '@{name}')"
					})}
				],
				treach: (item, $tr) => {
					let $select = $tr.querySelector("[select-enable]");
	
					ElementUtils.selectOptions($select, [
						{text: "啟用", value: "true"},
						{text: "停用", value: "false"}
					], item.enabled);
					$select.addEventListener("change", () => {
						updateScheduleParamegerEnable(item.id, $select.value)
					});
				}
			});
		}
		
		function openScheduleDetailEdit(){
			DialogUtils.window({
				title: "修改排程明細",
				url: "openScheduleDetailEdit",
				data: {id: scheduleId},
				callback: () => {
					doQuery();
				}
			});
		}
		
		function openJobGroupCreate(){
			DialogUtils.window({
				title: "新增工作群組",
				url: "openJobGroupCreate",
				data: {id: scheduleId},
				callback: () => {
					doQuery();
				}
			});
		}
		
		function openJobGroupSequence(){
			DialogUtils.window({
				title: "修改工作群組順序",
				url: "openJobGroupSequence",
				data: {id: scheduleId},
				callback: () => {
					doQuery();
				}
			});
		}
	
		function runJobGroup(id, name){
			DialogUtils.confirm({
				title: "執行工作群組提醒",
				text: `你確定要執行「<font style="color:red">${id} - ${name}</font>」工作群組？`,
				onConfirm: () => {
					HttpUtils.doPost({
						url: "executeJobGroup",
						data: {id}
					});
				}
			});
		}
		
		function updateJobGroupEnable(id, enable) {
			HttpUtils.doPost({
				url: "updateJobGroupEnable",
				data: {id, enable}
			});
		}
		
		function deleteJobGroup(id, name){
			DialogUtils.confirm({
				title: "刪除工作群組提醒",
				text: `你確定要刪除「<font style="color:red">${id} - ${name}</font>」工作群組？`,
				onConfirm: () => {
					HttpUtils.doPost({
						url: "deleteJobGroup",
						data: {id}
					});
				}
			});
		}
		
		function openJobGroupDetail(id){
			DialogUtils.window({
				title: "工作群組明細",
				url: "openJobGroupDetail",
				data: {id: id},
				callback: () => {
					doQuery();
				}
			});
		}
		
		function openScheduleParametersCreate(){
			DialogUtils.window({
				title: "新增排程參數",
				url: "openScheduleParametersCreate",
				data: {id: scheduleId},
				callback: () => {
					doQuery();
				}
			});
		}
		
		function deleteScheduleParameter(id, value){
			DialogUtils.confirm({
				title: "刪除排程參數提醒",
				text: `你確定要刪除「<font style="color:red">${id} - ${value}</font>」工作群組？`,
				onConfirm: () => {
					HttpUtils.doPost({
						url: "deleteScheduleParameter",
						data: {id}
					});
				}
			});
		}
		
		function openScheduleParameterEdit(id){
			DialogUtils.window({
				title: "修改排程參數",
				url: "openScheduleParameterEdit",
				data: {id: id},
				callback: () => {
					doQuery();
				}
			});
		}
		
		function updateScheduleParamegerEnable(id, enable){
			HttpUtils.doPost({
				url: "deleteScheduleParameter",
				data: {id, enable}
			});
		}
		
	</script>
</head>

<body>

	<div class="container-fluid p-3">
		<form id="myForm">
			<table class="table table-borderless">
				<tr>
					<td>
						<div class="input-group has-validation">
							<span class="input-group-text">排程代號</span> 
							<input name="scheduleId" type="text" class="form-control" readonly>
						</div>
					</td>
					<td>
						<div class="input-group has-validation">
							<span class="input-group-text">排程名稱</span> 
							<input name="scheduleName" type="text" class="form-control" readonly>
						</div>
					</td>
					<td style="width:50px">
						<button id="btn-editScheduleDetail" type="button" class="btn btn-secondary" onclick="openScheduleDetailEdit()">
							<i class="bi bi-gear-fill"></i>
						</button>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<div class="input-group">
							<span class="input-group-text">排程時間</span> 
							<input name="cronExp" type="text" class="form-control text-center" readonly>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<div class="input-group">
							<span class="input-group-text">排程描述</span>
							<textarea name="scheduleDescription" class="form-control" readonly></textarea>
						</div>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<table id="jobGroups" class="table table-bordered"></table>
					</td>
				</tr>
				<tr>
					<td colspan="3">
						<table id="scheduleParameters" class="table table-bordered"></table>
					</td>
				</tr>
			</table>
		</form>
	</div>

</body>

</html>